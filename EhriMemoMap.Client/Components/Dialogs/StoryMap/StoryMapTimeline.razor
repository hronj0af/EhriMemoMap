@inject IStringLocalizer<CommonResources> cl
@inject MapStateService MapState
@inject MapLogicService MapLogic
@inject IJSRuntime JS

<div class="storymap-timeline-container">
    @{
        var stops = MapState.NarrativeMap?.Stops?.ToList() ?? [];
    }
    @for (int i = 0; i < stops.Count; i++)
    {
        var stop = stops[i];
        var isLastItem = i == stops.Count - 1;
        <text>
            <a id="narrative-stop-@stop.Id" />
            <div class="storymap-timeline-item @(isLastItem ? "storymap-timeline-item-last" : "")">
                <div class="storymap-timeline-line @(isLastItem && IsStopExpanded(stop.Id) ? "storymap-timeline-line-last-expanded" : isLastItem ? "storymap-timeline-line-last-collapsed" : "")"></div>
                <div class="@(IsStopExpanded(stop.Id) ? "storymap-timeline-dot-big" : "storymap-timeline-dot-small")">
                    <RadzenImage Path="@GetDotIcon(stop.Id)" AlternateText="@(IsStopExpanded(stop.Id) ? "Rozbaleno" : "Sbaleno")" />
                </div>
                <div class="storymap-timeline-content">
                    <div style="cursor: pointer;" @onclick="() => OpenStoryMapTimelineLabel(stop.Id)">
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <h3 style="@(IsStopExpanded(stop.Id) ? "color:var(--Wine-Red)" : ""); margin: 0;">@(CultureInfo.CurrentCulture.ToString() == "cs-CZ" ? stop.LabelCs : stop.LabelEn)</h3>
                                    <RadzenImage Path="@GetArrowIcon(stop.Id)" AlternateText="@(IsStopExpanded(stop.Id) ? "Sbalit" : "Rozbalit")" />
                                </div>
                            </RadzenColumn>
                        </RadzenRow>
                    </div>
                    
                    @if (IsStopExpanded(stop.Id))
                    {
                        <div class="rz-mt-2">
                            <i>@(CultureInfo.CurrentCulture.ToString() == "cs-CZ" ? stop.DateCs : stop.DateEn)</i>
                        </div>
                        <div class="rz-mt-4">
                            @((MarkupString)((CultureInfo.CurrentCulture.ToString() == "cs-CZ" ? stop.DescriptionCs : stop.DescriptionEn) ?? ""))
                        </div>
                        
                        @if (stop?.Documents?.Any() ?? false)
                        {
                            <DocumentGallery ShowTitle="false" Documents="stop.Documents" />
                        }
                        
                        var sections = CultureInfo.CurrentCulture.ToString() == "cs-CZ" ? stop?.DescriptionSectionsCs : stop?.DescriptionSectionsEn;
                        @if (sections?.Any() ?? false)
                        {
                            <div class="rz-mt-4">
                                @for (int sectionIndex = 0; sectionIndex < sections.Length; sectionIndex++)
                                {
                                    var descSection = sections[sectionIndex];
                                    var sectionKey = $"{stop.Id}_{sectionIndex}";
                                    <div class="rz-mb-4">
                                        <div style="cursor: pointer;" @onclick="() => ToggleSection(sectionKey)">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <h4 style="color:var(--Wine-Red); margin: 0;">@descSection.Title</h4>
                                                <RadzenImage Path="@GetSectionArrowIcon(sectionKey)" AlternateText="@(IsSectionExpanded(sectionKey) ? "Sbalit" : "Rozbalit")" />
                                            </div>
                                        </div>
                                        @if (IsSectionExpanded(sectionKey))
                                        {
                                            <div class="rz-mt-2">
                                                @((MarkupString)(descSection.Text?.Nl2Br() ?? ""))
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </text>
    }
</div>

@code {
    private long? expandedStopId = null;
    private HashSet<string> expandedSections = new HashSet<string>();

    protected override void OnInitialized()
    {
        MapState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        MapState.OnChange -= StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var dotNetReference = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("mapAPI.initBlazorMapObject", dotNetReference, "StoryMapTimeline");
        }
    }

    [JSInvokable("OpenStoryMapTimelineLabel")]
    public async Task OpenStoryMapTimelineLabel(long stopId)
    {
        if (expandedStopId == stopId)
        {
            // Jika mengklik titik yang sudah terbuka, tutup titik tersebut
            expandedStopId = null;
            expandedSections.Clear(); // Tutup semua bagian saat menghentikan pembicaraan
            await MapLogic.ShowNarrativeMapPlaces();
        }
        else
        {
            // Buka titik baru (titik sebelumnya akan tertutup secara otomatis)
            expandedStopId = stopId;
            expandedSections.Clear(); // Tutup semua bagian saat membuka titik pemberhentian baru
            await MapLogic.ShowStopPlacesOnMap(stopId);
        }
        StateHasChanged();
    }

    private void ToggleSection(string sectionKey)
    {
        if (expandedSections.Contains(sectionKey))
        {
            expandedSections.Remove(sectionKey);
        }
        else
        {
            expandedSections.Add(sectionKey);
        }
        StateHasChanged();
    }

    private bool IsStopExpanded(long stopId)
    {
        return expandedStopId == stopId;
    }

    private bool IsSectionExpanded(string sectionKey)
    {
        return expandedSections.Contains(sectionKey);
    }

    private string GetDotIcon(long stopId)
    {
        return IsStopExpanded(stopId) ? "images/story-big-dot.png" : "images/story-small-dot.png";
    }

    private string GetArrowIcon(long stopId)
    {
        return IsStopExpanded(stopId) ? "images/arrow-down.png" : "images/arrow-right.png";
    }

    private string GetSectionArrowIcon(string sectionKey)
    {
        return IsSectionExpanded(sectionKey) ? "images/arrow-down.png" : "images/arrow-right.png";
    }
}
