@inject IStringLocalizer<CommonResources> cl
@inject MapService MapService
@inject IJSRuntime JSRuntime
@using System.Text.Json
@using System.IO
@using System.Globalization

@if (Documents != null && Documents.Count() > 0)
{
    @if (ShowTitle)
    {
        <h3 class="rz-mt-8 rz-mb-4">@cl["relatedDocuments"]</h3>
    }
    <div id="documents_@(guid)" class="rz-mt-8">
        @{
            var documentIndex = 0;
        }
        @foreach (var doc in Documents)
        {
            long actIndex = doc.Id;
            var currentDocumentIndex = documentIndex; // Lokální kopie pro tento iteration
            documentIndex += 1;
            var docTb = doc.Url?.FirstOrDefault()?.ThumbnailUrl ?? doc.Url?.FirstOrDefault()?.Url;

            <div id="doc-container-@guid-@currentDocumentIndex" style="position:relative; display:inline-block;height:100px;margin-right:3px">
                <RadzenImage style="cursor:pointer" class="document-photo" alt="@doc.GetTitle(CultureInfo.CurrentCulture.ToString())" Path="@docTb" onclick="@(() => ShowImage(actIndex, currentDocumentIndex))" />
                @if (doc.Type != "image" && doc.Type != "text")
                {
                    <RadzenImage Path="images/icon-play.png" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:48px; height:48px; opacity:0.9; pointer-events:none;" />
                }
            </div>

            <!-- Hidden container used by BiggerPicture -->
            <div id="documents_@actIndex" style="display:none;">
                @if (doc.Url != null)
                {
                    if (doc.Type == "image" || doc.Type == "text")
                    {
                        foreach (var url in doc.Url)
                        {
                            <a data-img="@url.Url"
                               data-caption="@doc.GetTitle(CultureInfo.CurrentCulture.ToString())"
                               data-alt="@doc.GetTitle(CultureInfo.CurrentCulture.ToString())">
                            </a>
                        }
                    }
                    else
                    {
                        // One anchor per video (keeps parity with previous behavior)
                        foreach (var url in doc.Url)
                        {
                            var sourcesJson = GetSourcesJson(url);
                            var thumb = url.ThumbnailUrl ?? docTb;
                            <a href="@url.Url"
                               data-sources="@sourcesJson"
                               data-thumb="@thumb">
                            </a>
                        }
                    }
                }
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public Document[]? Documents { get; set; }

    [Parameter]
    public bool ShowTitle { get; set; } = true;

    private string guid = Guid.NewGuid().ToString();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Documents != null && Documents.Any())
        {
            await JSRuntime.InvokeVoidAsync("adjustDocumentContainerWidths", guid);
        }
    }

    private async Task ShowImage(long imageNumber, int documentIndex)
    {
        if (Documents?.Any(a => a.Url?.Length > 1) ?? false)
            await JSRuntime.InvokeVoidAsync("initGallery", imageNumber, 0);
        else
            await JSRuntime.InvokeVoidAsync("initGallery", guid, documentIndex);
    }

    private static string GetSourcesJson(OmekaUrl? url)
    {
        if (url == null) return "[]";
        var items = new[] { new { src = url.Url, type = GetMimeTypeFromUrl(url.Url) } };
        return System.Text.Json.JsonSerializer.Serialize(items);
    }

    private static string GetMimeTypeFromUrl(string url)
    {
        var ext = Path.GetExtension(url)?.ToLowerInvariant();
        return ext switch
        {
            ".webm" => "video/webm",
            ".mp4" => "video/mp4",
            ".mp3" => "audio/mp3",
            ".ogv" or ".ogg" => "video/ogg",
            _ => "video/mp4"
        };
    }
}
